# 显卡 VBE 功能详解

[toc]



## VBE 概述







**VESA**（Video Electronics Standards Association，视频电子标准协会）是一个以非盈利为目的的国际组织，致力于制订推广<u>显示相关的标准</u>。

**VBE**（VESA BIOS Extension, **VESA BIOS扩展**）就是由VESA协会订制的标准规范。

- VBE规范可使软件的显示接口标准化
- VBE接口订制的目的是为了将图形、图像设备芯片（硬件）的操作简单化，这样可使操作图形图像设备的应用程序不必再关心硬件设备的内部操作以及一些特殊的图形图像知识。



**VBE 是一套软件访问图形图像控制器的标准接口**，它可以对<u>显示分辨率、颜色深度、管理帧缓存区等VGA硬件标准无法实现的功能</u>予以支持，同时它还为操作系统提供了控制刷新速率的控制器扩展接口。



VBE标准制定了一套VGA ROM BIOS的扩展服务。这些服务可**在DOS环境下通过 INT 10h 中断服务程序进入，或者直接调用非DOS操作系统的32位高效程序入口**



## VBE 规范

V**BE 可使高效运行中的应用程序直接对硬件设备进行安装和配置，从而进一步提高了平坦帧缓存在扩展分辨率下的执行性能**。平坦帧缓存是VBE 3.0引入的新式内存模式，它有别于传统的帧存块机制



从VBE 3.0开始，所有VBE/Core BIOS将支持双模式，可使运行于保护模式的16位程序直接调用保护模式的入口地址来执行VBE功能。





针对 VBE Core Functions Standard Version 3.0 ，介绍一些与操作系统相关的概念：

- **线性帧存的访问**。
  - 对于支持硬件线性帧存的图形硬件设备而言，应用程序只需一个供其写入数据的线性帧存地址便可显示画面。那么首先要做的就是了解线性帧存的物理地址，该物理地址保存在即将使用的显示模式结构 ModeInfoBlock 中。
  - 保护模式不能直接使用此物理地址，在使用前必须将这个物理地址映射到线性地址空间，再将线性地址映射到程序地址空间后才能被程序所用。
- **刷新率的控制**。
  - VBE 3.0提供控制刷新率的功能，它允许在设置显示模式时，向 VBE 提供 CRTC 刷新率定制值。
  - 此功能可为应用程序提供最大的灵活性来明确设置 CRTC 刷新率。
- **24位或32位像素的真色彩模式**。
  - 如果在开发过程中使用24位真色彩描画，那么在描画之前一定要确保控制器支持真色彩模式。
  - 真色彩模式可以是每像素24位（每像素点占3 B），亦可以是每像素32位（每像素点占4 B）。
  - 在通常情况下，32位真色彩模式仅需处理器执行一次双字（4B）写操作即可完成，从而其执行速度更快，但32位真色彩模式要求控制器至少拥有2 MB物理内存。

除此之外还有诸如获<u>得显示器操作边界</u>、<u>设置隔行扫描模式</u>、<u>设置三倍缓存区</u>、<u>使用立体眼镜</u>、<u>自动起始地址切换</u>、<u>左右影像同步</u>等功能





## VBE 功能

在实模式下，VBE借助BIOS中断服务程序 **INT 10h** 实现功能调用，并使用80x86的通用寄存器传递参数。

从VBE 3.0开始，VBE已允许保护模式使用16位或32位代码，直接调用特殊的入口地址实现功能调用。



所有 VBE 功能统一将 **AH 寄存器赋值为 4Fh 来区别标准 VGA BIOS 功能**，并使用 **AL 寄存器来指定 VBE 的功能号**，而 **BL 寄存器则用于指明追加或扩展的子功能**。





### 1. 获取VBE状态



对于VBE支持的功能，程序在执行功能调用前应向 AH 寄存器传入4Fh，如果调用执行成功，那么该值将会作为返回状态保存在 AL 寄存器中。

- 如果VBE功能执行成功，AH 寄存器将会返回 00h，
- 否则AH寄存器将记录失败类型。下表记录了VBE功能的调用失败类型。

【返回值】AX 寄存器用于记录 VBE 功能调用的返回状态。（32位保护模式除外，32位版本的功能调用不会返回任何状态信息或者返回码。）

- AH 表示状态码
- AL 保存 4Fh/14Fh



VBE返回状态值含义如下表：

| 寄存器 | 参数值 |          功能描述          |
| :----: | :----: | :------------------------: |
|   AL   |  4Fh   |         支持该功能         |
|   AL   |  14Fh  |        不支持该功能        |
|   AH   |  00h   |          操作成功          |
|   AH   |  01h   |          操作失败          |
|   AH   |  02h   |  当前硬件环境不支持此功能  |
|   AH   |  03h   | 此功能在当前图像模式下无效 |



应用程序应该将 AH 寄存器返回的任何非零值都作为失败条件来看待，VBE的后续版本可能会对这些错误码进行扩展。





### 2. VBE 模式号

标准的VGA模式号位宽是7位，目前的模式号范围是00h～13h,14h～7Fh可由OEM供应商自由定义显示模式。自从VGA BIOS功能00h将第7位作为擦除或保留显示缓存数据的标识符后，数值80h～FFh均保留使用。



为了区分7位的VGA模式号，**VBE模式号的位宽采用14位**。<u>程序在向 BX 寄存器传入模式号后，再通过 VBE 功能号 02h 来实现 VBE 模式的初始化</u>



VBE模式号的各个位功能说明如下表：

|   位   |                             说明                             |
| :----: | :----------------------------------------------------------: |
| D0-D8  | 模式号<br />如果D8=0，说明这不是 VESA 定义的 VBE 模式<br />如果D8=1，说明这是 VESA 定义的 VBE 模式 |
| D9-D12 |                        保留，必须为0                         |
|  D11   | 刷新率控制<br />如果D11=0，使用 BIOS 默认的刷新率<br />如果D11=1，使用 CRTC 定制值作为刷新率 |
| D12-13 |                        保留，必须为0                         |
|  D14   | 线性(Linear)/平坦(Flat)帧缓存区选择<br />如果D14=0，使用区间/窗口(Banked/Window) 帧缓存区<br />如果D14=1，使用线性/平坦(Linear/Flat) 帧缓存区 |
|  D15   | 保留显示缓存数据<br />如果D15=0，擦除显示缓存数据<br />如果D8=1，保留显示缓存数据 |



注意：VBE的起始模式号为100h，而且只有存在于VideoModeList（通过VBE的00h号功能可查询）中的VBE模式号才可用于设置。



VESA为VBE预定义的模式号如下表：

1. 字符显示模式

| 模式号 |  行  |  列  |
| :----: | :--: | :--: |
|  108h  |  80  |  60  |
|  109h  | 132  |  25  |
|  10Ah  | 132  |  43  |
|  10Bh  | 132  |  50  |
|  10Ch  | 132  |  60  |



2. 图像显示模式

| 模式号 |  分辨率   |    颜色种类    |
| :----: | :-------: | :------------: |
|  100h  |  640x400  |      256       |
|  101h  |  640x480  |      256       |
|  102h  |  800x600  |       16       |
|  103h  |  800x600  |      256       |
|  104h  | 1024x768  |       16       |
|  105h  | 1024x768  |      256       |
|  106h  | 1280x1024 |       16       |
|  107h  | 1280x1024 |      256       |
|  10Dh  |  320x200  | 32K (1:5:5:5） |
|  10Eh  |  320x200  |  64K (5:6:5)   |
|  10Fh  |  320x200  | 16.8M (8:8:8)  |
|  110h  |  640x480  | 32K (1:5:5:5)  |
|  111h  |  640x480  |  64K (5:6:5)   |
|  112h  |  640x480  | 16.8M (8:8:8)  |
|  113h  |  800x600  | 32K (1:5:5:5)  |
|  114h  |  800x600  |  64K (5:6:5)   |
|  115h  |  800x600  | 16.8M (8:8:8)  |
|  116h  | 1024x768  | 32K (1:5:5:5)  |
|  117h  | 1024x768  |  64K (5:6:5)   |
|  118h  | 1024x768  | 16.8M (8:8:8)  |
|  119h  | 1280x1024 | 32K (1:5:5:5)  |
|  11Ah  | 1280x1024 |  64K (5:6:5)   |
|  11Bh  | 1280x1024 | 16.8M (8:8:8)  |
| 81FFh  | 特殊模式  |                |

从VBE 2.0开始，VESA不再定义新的模式号，也不再强制支持旧的模式号。OEM供应商可在自己的产品中添加自定义VBE模式号，VESA只要求新添加的模式号都大于100h。



### 3. 获取VBE控制器信息



**VBE 规范的 00h 号功能可为调用者提供已安装的VBE软件和硬件信息**，其中不乏<u>包括图形图像控制器的功能信息、修订的VBE版本号以及OEM供应商信息</u>等，所有支持VBE功能的图形图像控制器都会提供这些信息。



在调用此功能前，VBE要求向其提供VbeInfoBlock信息块结构的起始地址，一旦执行成功，VBE会将上述信息保存在VbeInfoBlock信息块内。不同VBE版本的VbeInfoBlock信息块长度各不相同： 

- VBE 1.x版本的VbeInfoBlock信息块大小为256 B
- VBE 2.0+及后续版本的VbeInfoBlock信息块大小为512 B

VBE规范00h号功能的参数使用说明：

- 注意：必须向VbeInfoBlock信息块结构的VbeSignature字段预设ASCII码值’VBE2'，才能获取VBE 3.0信息。

| 输入/输出 |    参数    |                功能描述                |
| :-------: | :--------: | :------------------------------------: |
|  输入：   | AX = 4F00h |          获取 VBE 控制器信息           |
|           |  ES:DI =   | 指向 VbeInfoBlock 信息块结构的起始地址 |
|  输出：   |    AX =    |              VBE 返回状态              |



VbeInfoBlock信息块结构用于保存VBE控制器信息，VbeInfoBlock信息块结构各成员变量如下：

|     成员变量      | 偏移 | 变量大小 | 变量个数/固定值  |              描述              |
| :---------------: | :--: | :------: | :--------------: | :----------------------------: |
|   VbeSignature    |  0   |   1 B    | 'VESA'（4 * 1B） |          VBE 识别标志          |
|    VbeVersion     |  4   |   2 B    |      0300h       |       VBE 版本（BCD 码）       |
|   OemStringPtr    |  6   |   4 B    |        ？        |         OEM 字符串指针         |
|   Capabilities    |  10  |   1 B    |   4 dup（？）    |        图形控制器的机能        |
|   VideoModePtr    |  14  |   4 B    |        ？        |       VideoModeList 指针       |
|    TotalMemory    |  18  |   2 B    |        ？        | 64 KB 内存块数量（VBE2.0引入） |
|  OemSoftwareRev   |  20  |   2 B    |        ？        |     VBE 软件版本（BCD 码）     |
| OemVendorNamePtr  |  22  |   4 B    |        ？        |       OEM 供应商名字指针       |
| OemProductNamePtr |  26  |   4 B    |        ？        |          OEM 产品指针          |
| OemProductRevPtr  |  30  |   4 B    |        ？        |        OEM 产品版本指针        |
|     Reserved      |  34  |   1 B    |  222 dup（？）   |              保留              |
|      OemData      | 256  |   1 B    |  256 dup（？）   |            OEM 数据            |

- VbeSignature 字段保存着ASCII码值’VESA'，如果我们想获得VBE 2.0+的扩展信息，则必须在执行系统调用前预设ASCII码值’VBE2'
- OemStringPtr、OemVerdorNamePtr、OemProductNamePtr、OemProduceRevPtr字段均是远指针，在VBE 3.0版本中，当VbeSignature预设ASCII码值’VBE2’时，这些字符串可能会保存在OemData空间
- 在VBE 3.0版本中，当VbeSignature预设ASCII码值’VBE2'时，这些字符串可能会保存在Reserved空间
- TotalMemory指示VBE芯片预装的最大物理内存容量，以64 KB为单位，例如4表示256 KB、8表示512 KB
- <u>Capabilities是VbeInfoBlock信息块最重要的字段</u>，它记录着图形环境支持的特性



Capabilities字段的位功能说明如下表：

|  位   |  值  |                 功能说明                 |
| :---: | :--: | :--------------------------------------: |
|  D0=  |  0   |     DAC 固定宽度，每个主色区占 6 位      |
|       |  1   |    DAC 宽度可调整为每个主色区占 8 位     |
|  D1=  |  0   |           控制器兼容 VGA 标准            |
|       |  1   |          控制器不兼容 VGA 标准           |
|  D2=  |  0   |            通用的 RAMDAC 操作            |
|       |  1   | 向 RAMDAC 写入大块信息时，使用功能号 09h |
|  D3=  |  0   |            不支持硬件立体信号            |
|       |  1   |          控制器支持硬件立体信号          |
|  D4=  |  0   |   立体信号由扩展的 VESA 立体控制器支持   |
|       |  1   |      立体信号由 VESA EVA 控制器支持      |
| D5:31 |  -   |                   保留                   |





### 4. 获取 VBE 模式信息

**VBE 规范的 01h 号功能用于获得指定模式号（自于VideoModeList列表）的 VBE 显示模式扩展信息**，<u>这些信息会保存在一个名为ModeInfoBlock的结构里，结构长度为256B</u>。

在调用此功能前，VBE 要求向其提供 ModeInfoBlock 结构的起始地址，一旦执行成功，VBE 会将显示模式扩展信息保存在 ModeInfoBlock 结构体内。

VBE规范01h号功能的参数使用说明如下表

| 输入/输出 |    参数    |                功能描述                |
| :-------: | :--------: | :------------------------------------: |
|  输入：   | AX = 4F01h |          获取 VBE 控制器信息           |
|           |    CX =    |                 模式号                 |
|           |  ES:DI =   | 指向 VbeInfoBlock 信息块结构的起始地址 |
|  输出：   |    AX =    |              VBE 返回状态              |



下面是ModeInfoBlock结构各成员变量的功能说明：

1. 所有 VBE 版本强制提供的信息

|     成员变量     | 偏移 | 大小 | 数值 |             描述             |
| :--------------: | :--: | :--: | :--: | :--------------------------: |
|  ModeAttributes  |  0   | 2 B  |  ？  |           模式属性           |
|  WinAAttributes  |  2   | 1 B  |  ？  |          窗口A属性           |
|  WinBAttributes  |  3   | 1 B  |  ？  |          窗口B属性           |
|  WinGranularity  |  4   | 2 B  |  ？  |    窗口颗粒度（单位 KB）     |
|     WinSize      |  6   | 2 B  |  ？  |     窗口大小（单位 KB）      |
|   WinASegment    |  8   | 2 B  |  ？  |   窗口A的段地址（实模式）    |
|   WinBSegment    |  10  | 2 B  |  ？  |   窗口B的段地址（实模式）    |
|    WinFuncPtr    |  12  | 4 B  |  ？  | 窗口功能的入口地址（实模式） |
| BytesPerScanLine |  16  | 2 B  |  ？  |    每条扫描线占用的字节数    |



2. VBE1.2 以上版本强制提供的信息

|      成员变量      | 偏移 | 大小 | 数值 |           描述           |
| :----------------: | :--: | :--: | :--: | :----------------------: |
|    XResolution     |  18  | 2 B  |  ？  | 水平分辨率（像素或字符） |
|    YResolution     |  20  | 2 B  |  ？  | 垂直分辨率（像素或字符） |
|     XCharSize      |  22  | 1 B  |  ？  |     字符宽度（像素）     |
|     YCharSize      |  23  | 2 B  |  ？  |     字符高度（像素）     |
|   NumberOfPlanes   |  24  | 1 B  |  ？  |       内存平面数量       |
|    BitsPerPixel    |  25  | 1 B  |  ？  |      每像素占用位宽      |
|   NumberOfBanks    |  26  | 1 B  |  ？  |          块数量          |
|    MemoryModel     |  27  | 1 B  |  ？  |       内存模式类型       |
|      BankSize      |  28  | 1 B  |  ？  |    块容量（单位 KB）     |
| NumberOfImagePages |  29  | 1 B  |  ？  |        图像页数量        |
|      Reserved      |  30  | 1 B  |  1   |    为分页功能保留使用    |

3. 直接颜色描画区域（支持 Direct Color 和 YUV 内存模式）

|      成员变量       | 偏移 | 大小 | 数值 |             描述              |
| :-----------------: | :--: | :--: | :--: | :---------------------------: |
|     RedMaskSize     |  31  | 1 B  |  ？  |  Direct Color 的红色屏蔽位宽  |
|  RedFieldPosition   |  32  | 1 B  |  ？  |     红色屏蔽位的起始位置      |
|    GreenMaskSize    |  33  | 1 B  |  ？  |  Direct Color 的绿色屏蔽位宽  |
| GreenFieldPosition  |  34  | 1 B  |  ？  |     绿色屏蔽位的起始位置      |
|    BlueMaskSize     |  35  | 1 B  |  ？  |  Direct Color 的蓝色屏蔽位宽  |
|  BlueFieldPosition  |  36  | 1 B  |  ？  |     蓝色屏蔽位的起始位置      |
|    RsvdMaskSize     |  37  | 1 B  |  ？  | Direct Color 的保留色屏蔽位宽 |
|  RsvdFieldPosition  |  38  | 1 B  |  ？  |    保留色屏蔽位的起始位置     |
| DirectColorModeInfo |  39  | 1 B  |  ？  |     Direct Color 模式属性     |

4. VBE2.0 以上版本强制提供的信息

|  成员变量   | 偏移 | 大小 | 数值 |              描述              |
| :---------: | :--: | :--: | :--: | :----------------------------: |
| PhysBasePtr |  40  | 4 B  |  ？  | 平坦帧缓存区模式的起始物理地址 |
|  Reserved   |  44  | 4 B  |  0   |         保留，必须为0          |
|  Reserved   |  48  | 2 B  |  0   |         保留，必须为0          |

5. VBE3.0 以上版本强制提供的信息

|        成员变量         | 偏移 | 大小 |   数值    |                   描述                    |
| :---------------------: | :--: | :--: | :-------: | :---------------------------------------: |
|   LinBytesPerScanLine   |  50  | 2 B  |    ？     |     线性模式的每条扫描线占用的字节数      |
|  BnkNumberOfImagePages  |  52  | 1 B  |    ？     |            块模式的图像页数量             |
|  LinNumberOfImagePages  |  53  | 1 B  |    ？     |           线性模式的图像页数量            |
|     LinRedMaskSize      |  54  | 1 B  |    ？     |  Direct Color 的红色屏蔽位宽（线性模式）  |
|   LinRedFieldPosition   |  55  | 1 B  |    ？     |     红色屏蔽位的起始位置（线性模式）      |
|    LinGreenMaskSize     |  56  | 1 B  |    ？     |  Direct Color 的绿色屏蔽位宽（线性模式）  |
| LinGreenFieldPositiondb |  57  | 1 B  |    ？     |     绿色屏蔽位的起始位置（线性模式）      |
|     LinBlueMaskSize     |  58  | 1 B  |    ？     |  Direct Color 的蓝色屏蔽位宽（线性模式）  |
|  LinBlueFieldPosition   |  59  | 1 B  |    ？     |     蓝色屏蔽位的起始位置（线性模式）      |
|     LinRsvdMaskSize     |  60  | 1 B  |    ？     | Direct Color 的保留色屏蔽位宽（线性模式） |
|  LinRsvdFieldPosition   |  61  | 1 B  |    ？     |    保留色屏蔽位的起始位置（线性模式）     |
|      MaxPixelClock      |  62  | 4 B  |    ？     |     图像模式的最大像素时钟（单位 Hz）     |
|        Reserved         |  66  | 1 B  | 189dup(?) |          ModeInfoBlock 剩余空间           |





ModeInfoBlock结构的第一个字段，ModeAttributes字段描述了图形模式重要的特性，ModeAttributes字段的位功能说明如下表：

|              位               |  值  |           功能说明           |
| :---------------------------: | :--: | :--------------------------: |
|         D0 = 硬件配置         |  0   |        不支持硬件配置        |
|                               |  1   |         支持硬件配置         |
|           D1= 保留            |  1   |             保留             |
|  D2= BIOS 支持 TTY 输出功能   |  0   |   BIOS 不支持 TTY 输出功能   |
|                               |  1   |    BIOS 支持 TTY 输出功能    |
|       D3= 单色/彩色模式       |  0   |           单色模式           |
|                               |  1   |           彩色模式           |
|         D4 = 模式类型         |  0   |           文本模式           |
|                               |  1   |           图形模式           |
|       D5 = VGA 兼容模式       |  0   |      支持 VGA 兼容模式       |
|                               |  1   |     不支持 VGA 兼容模式      |
| D6 = VGA 兼容窗口帧缓存区模式 |  0   | VGA 兼容窗口帧缓存区模式有效 |
|                               |  1   | VGA 兼容窗口帧缓存区模式无效 |
|     D7 = 线性帧缓存区模式     |  0   |     线性帧缓存区模式无效     |
|                               |  1   |     线性帧缓存区模式有效     |
|        D8 = 双扫描模式        |  0   |        双扫描模式无效        |
|                               |  1   |        双扫描模式有效        |
|         D9 = 隔行模式         |  0   |         隔行模式无效         |
|                               |  1   |         隔行模式有效         |
|     D10 = 硬件三倍缓存区      |  0   |      硬件三倍缓存区无效      |
|                               |  1   |      硬件三倍缓存区有效      |
|     D11 = 硬件立体显示器      |  0   |      硬件立体显示器无效      |
|                               |  1   |      硬件立体显示器有效      |
|    D12 = 双显示器起始地址     |  0   |     双显示器起始地址无效     |
|                               |  1   |     双显示器起始地址有效     |
|       D13 - D15 = 保留        |  -   |              -               |
|                               |      |                              |

- 如果使用无效的模式号进行查询，那么ModeAttributes字段中的D0位会标识为不支持硬件配置

- 其D2位则标识BIOS是否支持TTY的输出和滚动功能。

  - 如果D2=1，那么BIOS中断服务程序INT 10h将支持下表罗列的所有标准输出功能。

  | 功能号 |              功能描述              |
  | :----: | :--------------------------------: |
  |  01h   |            设置光标大小            |
  |  02h   |            设置光标位置            |
  |  06h   |     向上滚动 TTY 窗口或窗口块      |
  |  07h   |     向下滚动 TTY 窗口或窗口块      |
  |  09h   |      在光标位置上写字符或属性      |
  |  0Ah   |         在光标位置上写字符         |
  |  0Eh   | 在光标位置上写字符，光标随字符前进 |

- ModeAttributes字段的D6和D7位可协同使用，即硬件可以同时支持窗口帧缓存区模式和线性帧缓存区模式，详细的缓存区模式组合说明请参见下表。

  |              功能描述              |  D6  |  D7  |
  | :--------------------------------: | :--: | :--: |
  |          窗口帧缓存区模式          |  0   |  0   |
  |                N/A                 |  1   |  0   |
  | 窗口帧缓存区模式和线性帧缓存区模式 |  0   |  1   |
  |          线性帧缓存区模式          |  1   |  1   |

  







ModeInfoBlock结构中的WinAAttributes和WinBAttributes字段描述了窗口的特征，例如窗口是否存在、读写权限等，下表是窗口属性各位的功能说明。

|       位        |  值  |         功能说明         |
| :-------------: | :--: | :----------------------: |
| D0 = 窗口重定位 |  0   | 单窗口，不支持窗口重定位 |
|                 |  1   |      支持窗口重定位      |
|  D1 = 窗口可读  |  0   |        窗口不可读        |
|                 |  1   |         窗口可读         |
|  D2 = 窗口可写  |  0   |        窗口不可写        |
|                 |  1   |         窗口可写         |
| D3 - D7 = 保留  |  -   |            -             |





ModeInfoBlock结构中的BytesPerScanLine字段记录着块模式的每条逻辑扫描线占用字节数，而LinBytesPerScanLine字段则记录着线性模式的每条逻辑扫描线占用字节数。字段MemoryModel保存着该显示模式支持的内存模式类型，下表罗列了所有内存模式类型。

|  类型号   |       类型描述        |
| :-------: | :-------------------: |
|    00h    |       Text mode       |
|    01h    |     CGA graphics      |
|    02h    |   Hercules graphics   |
|    03h    |        Planar         |
|    04h    |     Packed pixel      |
|    05h    | Non-Chain，4256 color |
|    06h    |     Direct Color      |
|    07h    |          YUV          |
| 08h - 0Fh |  保留，由 VESA 定义   |
| 10h - FFh |    由 OEM 厂商定义    |



自VBE 1.2以后，Direct Color 图像模式改用Direct Color内存类型，并借助ModeInfoBlock结构中的XXXXMaskSize、LinXXXXMaskSize、XXXXFieldPosition和LinXXXXFieldPosition字段来描述像素点的格式（红、绿、蓝以及保留所占位域）, BitsPerPixel字段描述像素点位宽。字段DirectColorModeInfo描述了Direct Color内存类型的重要特征，下表是其特征位的功能说明。

|        位        |  值  |            功能说明             |
| :--------------: | :--: | :-----------------------------: |
|   D0 = 颜色带    |  0   |         颜色带是固定的          |
|                  |  1   |        颜色带是可编程的         |
| D1 = Rsvd 位区域 |  0   |       Rsvd 位区域是保留的       |
|                  |  1   | Rsvd 位区域是可被应用程序使用的 |



ModeInfoBlock结构中的PhysBasePtr字段保存着线性帧缓存区（现代图形图像系统常用的描画空间）的起始物理地址。此物理地址必须通过页表映射转换为线性地址后才能供程序访问，不同模式的线性帧缓存区起始物理地址可能位于不同地址处。



### 5．设置VBE显示模式



VBE规范的02h号功能用于初始化图形图像控制器并设置VBE显示模式，其中的VBE模式号已在前文中予以介绍。

如果VBE显示模式设置失败，BIOS将继续使用当前图形环境并返回错误码。



VBE规范02h号功能的参数使用说明如下表：

| 输入/输出 |    参数    |   参数位    |           功能描述           |
| :-------: | :--------: | :---------: | :--------------------------: |
|  输入：   | AX = 4F02h |             |      设置 VBE 显示模式       |
|           |    BX =    |  D0 - D8 =  |          VBE 模式号          |
|           |            | D9 - D10 =  |       保留（必须为0）        |
|           |            |   D11 = 0   |        使用当前刷新率        |
|           |            |   D11 = 1   |    使用 CRTC 刷新率定制值    |
|           |            | D12 - D13 = |  VBE/AF 保留使用（必须为0）  |
|           |            |   D14 = 0   |     使用窗口帧缓存区模式     |
|           |            |   D14 = 1   |     使用线性帧缓存区模式     |
|           |            |   D15 = 0   |       清空显示内存数据       |
|           |            |   D15 = 1   |       保留显示内存数据       |
|           |  ES:DI =   |             | CRTCInfoBlock 结构的起始地址 |
|  输出：   |    AX =    |             |         VBE 返回状态         |

- 参数寄存器BX的D11位用于选择刷新率
  - 当D11=1时BIOS将使用CRTCInfoBlock结构来定制刷新率
  - 当D11=0时ES:DI寄存器将被忽略。
- 根据ModeInfoBlock结构提供的VBE显示模式扩展信息，可由参数寄存器BX的D14位来选择帧缓存区模式（线性帧缓存区模式或窗口帧缓存区模式），如果选择模式与VBE显示模式扩展信息不符，那么调用将会以失败而告终。



CRTCInfoBlock结构的成员变量功能说明如下表：

|      成员变量       | 偏移 | 变量大小 | 变量个数/固定值 |          描述          |
| :-----------------: | :--: | :------: | :-------------: | :--------------------: |
|   HorizontalTotal   |  0   |   2 B    |       ？        |      全部水平像素      |
| HorizontalSyncStart |  2   |   2 B    |       ？        |    起始水平同步像素    |
|  HorizontalSyncEnd  |  4   |   2 B    |       ？        |    结尾水平同步像素    |
|    VerticalTotal    |  6   |   2 B    |       ？        |      全部垂直像素      |
|  VerticalSyncStart  |  8   |   2 B    |       ？        |    起始垂直同步像素    |
|   VerticalSyncEnd   |  10  |   2 B    |       ？        |    结尾垂直同步像素    |
|        Flags        |  12  |   1 B    |       ？        |          标志          |
|     PixelClock      |  13  |   4 B    |       ？        |  像素时钟（单位 Hz）   |
|     RefreshRate     |  17  |   2 B    |       ？        | 刷新率（单位 0,01 Hz） |
|      Reserved       |  19  |   1 B    |    40 dup(?)    |          保留          |

- CRTCInfoBlock结构中的Flags字段记录着扫描模式以及水平/垂直同步方向等信息。

- PixelClock字段保存着标准像素时钟值，通过标准像素时钟值可计算出该图形模式的刷新率，以下是刷新率的计算公式。
  $$
  refreshRate = \frac{PixelClock}{HorizontalTotal \times VerticalTotal}
  $$

- 例如，1024×768分辨率（图像显示模式）的HorizontalTotal为1360, VerticalTotal为802，标准像素时钟为65 MHz，则计算过程如下。

$$
refreshRate = \frac{65 000 000}{1360 \times 802} = 59.59 Hz
$$

- CRTCInfoBlock结构中的RefreshRate字段记录着图形模式的刷新率，通过上面公式计算而得，单位为0.01 Hz





### 6．获取当前VBE模式

VBE规范的03h号功能用于获取当前使用的VBE显示模式，它只支持BIOS中断服务程序调用，而不支持VBE 3.0的保护模式直接调用

VBE规范03h号功能的参数使用功能说明如下表：

| 输入/输出 |    参数    |   参数位   |       功能描述       |
| :-------: | :--------: | :--------: | :------------------: |
|  输入：   | AX = 4F03h |            |  设置 VBE 显示模式   |
|  输出：   |    AX =    |            |     VBE 返回状态     |
|           |    Bx =    | D0 - D13 = |        模式号        |
|           |            |  D14 = 0   |   窗口帧缓存区模式   |
|           |            |    = 1     |   线性帧缓存区模式   |
|           |            |  D15 = 0   |  设置模式后清空内存  |
|           |            |    = 1     | 设置模式后不清空内存 |





### 7．保存/还原状态

VBE规范的04h号功能提供了一套完整的机制来保存和还原图形图像控制器的硬件状态，此功能是VGA BIOS中断服务程序1Ch功能的全集

VBE规范04h号功能的参数使用功能说明如下表：

| 输入/输出 |    参数    | 参数位 |            功能描述            |
| :-------: | :--------: | :----: | :----------------------------: |
|  输入：   | AX = 4F04h |        |         保存/还原状态          |
|           |    DL =    |  00h   |  返回保存/还原状态缓存区容量   |
|           |            |  01h   |            保存状态            |
|           |            |  02h   |            还原状态            |
|           |    CX =    |        |            请求状态            |
|           |            |  D0 =  |    保存/还原硬件控制器状态     |
|           |            |  D1 =  |    保存/还原 BIOS 数据状态     |
|           |            |  D2 =  |       保存/还原 DAC 状态       |
|           |            |  D3 =  |      保存/还原寄存器状态       |
|           |  ES:BX =   |        |           缓存区指针           |
|  输出：   |    AX =    |        | 状态缓存区的块数量（每块 64B） |



## 代码示例

